 {% extends 'core/base.html' %}

{% block title %}Browse Courses - StockLearn{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">Browse Courses</h1>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            Master stock market investing with our comprehensive courses. Learn from experts and boost your trading skills.
        </p>
    </div>

    <!-- Search and Stats Bar -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">
                    <span class="font-semibold text-blue-600">{{ courses.count }}</span> courses available
                </span>
                {% if request.GET.category or request.GET.level %}
                <span class="text-sm text-gray-500">
                    Filtered results
                </span>
                {% endif %}
            </div>
            
            <!-- Search Form -->
            <form method="get" class="flex-1 max-w-md">
                <div class="relative">
                    <input type="text" name="search" value="{{ request.GET.search }}" 
                           placeholder="Search courses..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    {% if request.GET.category %}
                    <input type="hidden" name="category" value="{{ request.GET.category }}">
                    {% endif %}
                    {% if request.GET.level %}
                    <input type="hidden" name="level" value="{{ request.GET.level }}">
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Filters Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 sticky top-4">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-semibold text-lg text-gray-800">Filters</h3>
                    {% if request.GET.category or request.GET.level or request.GET.search %}
                    <a href="{% url 'core:course_list' %}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                        Clear All
                    </a>
                    {% endif %}
                </div>
                
                <!-- Categories -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-3">Categories</h4>
                    <div class="space-y-2">
                        <a href="{% url 'core:course_list' %}{% if request.GET.search %}?search={{ request.GET.search }}{% endif %}" 
                           class="flex items-center justify-between group {% if not request.GET.category %}font-semibold text-blue-600{% else %}text-gray-600 hover:text-blue-600{% endif %}">
                            <span>All Categories</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">All</span>
                        </a>
                        {% for category in categories %}
                        <a href="?category={{ category.id }}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" 
                           class="flex items-center justify-between group {% if request.GET.category == category.id|stringformat:'i' %}font-semibold text-blue-600{% else %}text-gray-600 hover:text-blue-600{% endif %}">
                            <span>{{ category.name }}</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded group-hover:bg-blue-100">{{ category.course_set.count }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Level -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-3">Difficulty Level</h4>
                    <div class="space-y-2">
                        <a href="{% url 'core:course_list' %}{% if request.GET.category %}?category={{ request.GET.category }}{% endif %}{% if request.GET.search %}{% if request.GET.category %}&{% else %}?{% endif %}search={{ request.GET.search }}{% endif %}" 
                           class="flex items-center justify-between group {% if not request.GET.level %}font-semibold text-blue-600{% else %}text-gray-600 hover:text-blue-600{% endif %}">
                            <span>All Levels</span>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded">All</span>
                        </a>
                        <a href="?level=beginner{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" 
                           class="flex items-center justify-between group {% if request.GET.level == 'beginner' %}font-semibold text-blue-600{% else %}text-gray-600 hover:text-blue-600{% endif %}">
                            <span>Beginner</span>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Easy</span>
                        </a>
                        <a href="?level=intermediate{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" 
                           class="flex items-center justify-between group {% if request.GET.level == 'intermediate' %}font-semibold text-blue-600{% else %}text-gray-600 hover:text-blue-600{% endif %}">
                            <span>Intermediate</span>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Medium</span>
                        </a>
                        <a href="?level=advanced{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" 
                           class="flex items-center justify-between group {% if request.GET.level == 'advanced' %}font-semibold text-blue-600{% else %}text-gray-600 hover:text-blue-600{% endif %}">
                            <span>Advanced</span>
                            <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Hard</span>
                        </a>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="border-t border-gray-200 pt-6">
                    <h4 class="font-medium text-gray-700 mb-3">Quick Stats</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span>Total Courses:</span>
                            <span class="font-semibold">{{ courses.count }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Free Courses:</span>
                            <span class="font-semibold text-green-600">
                                {% with free_courses=courses|dictsortreversed:"price" %}
                                    {{ free_courses|length }}
                                {% endwith %}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span>Categories:</span>
                            <span class="font-semibold">{{ categories.count }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Courses Grid -->
        <div class="lg:col-span-3">
            <!-- Active Filters -->
            {% if request.GET.category or request.GET.level or request.GET.search %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 text-sm">
                        <span class="text-blue-700 font-medium">Active filters:</span>
                        {% if request.GET.search %}
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                            Search: "{{ request.GET.search }}"
                        </span>
                        {% endif %}
                        {% if request.GET.category %}
                        {% with active_category=categories|dictsort:"id"|first %}
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                            Category: {{ active_category.name }}
                        </span>
                        {% endwith %}
                        {% endif %}
                        {% if request.GET.level %}
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                            Level: {{ request.GET.level|title }}
                        </span>
                        {% endif %}
                    </div>
                    <a href="{% url 'core:course_list' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        Clear all
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Courses Grid -->
            {% if courses %}
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                {% for course in courses %}
                <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 border border-gray-100">
                    <!-- Course Thumbnail with Cloudinary -->
                    <div class="relative">
                        {% if course.thumbnail_url %}
                        <img src="{{ course.thumbnail_url }}" alt="{{ course.title }}" 
                             class="w-full h-48 object-cover">
                        {% else %}
                        <div class="w-full h-48 bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-4xl"></i>
                        </div>
                        {% endif %}
                        
                        <!-- Course Badges -->
                        <div class="absolute top-3 left-3 flex flex-col space-y-2">
                            <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded font-semibold">
                                {{ course.level|title }}
                            </span>
                            {% if course.price == 0 %}
                            <span class="bg-green-600 text-white text-xs px-2 py-1 rounded font-semibold">
                                Free
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Category Badge -->
                        {% if course.category %}
                        <div class="absolute top-3 right-3">
                            <span class="bg-white text-gray-700 text-xs px-2 py-1 rounded font-medium shadow-sm">
                                {{ course.category.name }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="p-6">
                        <!-- Course Title and Description -->
                        <h3 class="text-xl font-semibold text-gray-800 mb-2 line-clamp-2">{{ course.title }}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ course.description }}</p>
                        
                        <!-- Course Meta Info -->
                        <div class="flex items-center text-sm text-gray-500 mb-4 space-x-4">
                            <span class="flex items-center">
                                <i class="fas fa-clock mr-1 text-blue-500"></i>
                                {% if course.duration_hours %}
                                    {{ course.duration_hours }}h
                                {% else %}
                                    Self-paced
                                {% endif %}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-book mr-1 text-green-500"></i>
                                {{ course.lessons.count }} lessons
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-signal mr-1 text-purple-500"></i>
                                {{ course.level|title }}
                            </span>
                        </div>
                        
                        <!-- Price and Instructor -->
                        <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                            <div class="flex items-center space-x-3">
                                <!-- Instructor Avatar -->
                                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                    {% if course.instructor %}
                                        {{ course.instructor|first|upper }}
                                    {% else %}
                                        <i class="fas fa-user text-xs"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-700">
                                        {{ course.instructor|default:"Expert Instructor" }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Price and CTA -->
                            <div class="text-right">
                                <div class="mb-1">
                                    {% if course.price == 0 %}
                                    <span class="text-lg font-bold text-green-600">Free</span>
                                    {% else %}
                                    <span class="text-lg font-bold text-gray-800">${{ course.price }}</span>
                                    {% endif %}
                                </div>
                                <a href="{% url 'core:course_detail' course.id %}" 
                                   class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition duration-200 inline-flex items-center space-x-1">
                                    <span>View Course</span>
                                    <i class="fas fa-arrow-right text-xs"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="bg-white rounded-xl shadow-md p-12 text-center">
                <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-2xl font-semibold text-gray-700 mb-2">No courses found</h3>
                <p class="text-gray-500 mb-6 max-w-md mx-auto">
                    {% if request.GET.search %}
                    No courses match your search for "{{ request.GET.search }}". Try different keywords or browse all categories.
                    {% else %}
                    No courses match your current filters. Try adjusting your selection to see more courses.
                    {% endif %}
                </p>
                <a href="{% url 'core:course_list' %}" 
                   class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 inline-flex items-center space-x-2">
                    <i class="fas fa-redo"></i>
                    <span>Browse All Courses</span>
                </a>
            </div>
            {% endif %}

            <!-- Load More (if needed in future) -->
            {% if courses.has_other_pages %}
            <div class="mt-8 text-center">
                <div class="inline-flex space-x-2">
                    {% if courses.has_previous %}
                    <a href="?page={{ courses.previous_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" 
                       class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">
                        Previous
                    </a>
                    {% endif %}
                    
                    {% if courses.has_next %}
                    <a href="?page={{ courses.next_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" 
                       class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Next Page
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add search debouncing
    const searchInput = document.querySelector('input[name="search"]');
    let searchTimeout;
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.form.submit();
            }, 500);
        });
    }

    // Add smooth scrolling for filter links
    const filterLinks = document.querySelectorAll('a[href*="category"], a[href*="level"]');
    filterLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            // Add loading state
            const coursesGrid = document.querySelector('.grid-cols-1\\:md\\:grid-cols-2');
            if (coursesGrid) {
                coursesGrid.style.opacity = '0.7';
                coursesGrid.style.transition = 'opacity 0.3s';
            }
        });
    });
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}